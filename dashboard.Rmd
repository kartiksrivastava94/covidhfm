---
title: "PGRP/CEGIS COVID-19 Monitoring Dashboard"
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
output: flexdashboard::flex_dashboard
runtime: shiny
---

Food security
====================================

```{r, echo=FALSE, message=FALSE, results='hide'}
rm(list = ls())

library(flexdashboard)
library(tidyverse)
library(ggplot2)
library(foreign)
library(purrr)
library(dplyr)
library(plotly)
library(sf)
library(DT)

file_name <- "C:/Users/sriva/Desktop/TSMap/TelanganaMandals.shp"
nc <- st_read(file_name)

db <- read.dbf("C:/Users/sriva/Desktop/TSMap/TelanganaMandals.dbf")

db$mandalname <- paste(db$NewMand4, db$New_Dist_4, sep = ", ")

set.seed(456)
db$pop        <- runif(dim(db[1])) 

set.seed(123)
db$food       <- round(runif(dim(db)[1])*100, digits = 2)

nc <- merge(nc, db, by = c("NewMand4", "New_Dist_4"))
```

Column {data-width=350}
------------------------------------
### State-wide estimate for population able to access food {.value-box}

```{r}
state_av     <- formatC(weighted.mean(db$food, db$pop), digits = 2, format = "f")

renderValueBox({
  valueBox(
    value = state_av,
    icon = "fa-area-chart",
    color = "steelblue"
  )
})
```
  
### Bottom 15 mandals
```{r}
db20 <-  db[order(db$food),]
db20 <-  db20 %>% top_n(-15)

bpf <- ggplot(data = db20, mapping = aes(x = reorder(mandalname, -food), food, text = paste(mandalname, " ", food, "%", sep = ""))) + 
        geom_bar(stat = "identity", fill = "steelblue") +
        theme(axis.title.y = element_blank(),
              axis.title.x = element_blank(),
              panel.grid.major = element_blank(), 
              panel.grid.minor = element_blank()) +
        coord_flip() + ggtitle("% able to access food")
bpf <- bpf + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                   panel.background = element_blank(), axis.line = element_line(colour = "black"))
ggplotly(bpf, tooltip = "text")
```

### All mandals
```{r}
DT::datatable(db[, c("mandalname", "food")],
              rownames = FALSE, 
              colnames = c('Mandal', '% able to access food'),
              options = list(pageLength = 5)
)
``` 

Column {data-width=650}
-------------------------------------

### Interactive map
```{r, echo=FALSE, message=FALSE}
plot_ly(nc) %>% 
  add_sf(
    color = ~food, 
    split = ~mandalname, 
    span = I(1),
    text = ~paste(mandalname, food),
    hoverinfo = "text",
    hoveron = "fills"
  ) %>%
  layout(showlegend = FALSE) %>%
  colorbar(title = "% able to access food")
```
